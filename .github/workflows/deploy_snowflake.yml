name: Snowflake Schema Change

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-snowflake-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install schemachange
        run: pip install schemachange

      - name: Determine Credentials
        id: credentials
        shell: bash
        run: |
          # If SNOWFLAKE_KEY secret exists and is not empty, use it.
          if [[ -n "${{ secrets.SNOWFLAKE_KEY }}" ]]; then
            echo "Using SNOWFLAKE_KEY"
            # We can pass the key content directly via env var since standard Snowflake connectors 
            # often require a path. However, schemachange might support env var directly or we write to file.
            # Best practice for CLI tools often involves writing the key to a temporary file.
            echo "${{ secrets.SNOWFLAKE_KEY }}" > snowflake_key.p8
            chmod 600 snowflake_key.p8
            echo "SNOWFLAKE_PRIVATE_KEY_PATH=$(pwd)/snowflake_key.p8" >> $GITHUB_ENV
            # Set a flag to know we are using key pair auth
            echo "USE_KEY_PAIR=true" >> $GITHUB_ENV
          else
            echo "Using SNOWFLAKE_PASSWORD"
            echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}" >> $GITHUB_ENV
            echo "USE_KEY_PAIR=false" >> $GITHUB_ENV
          fi

      - name: Run schemachange
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          # The password env is set in the previous step if applicable
        run: |
          # Construct the command dynamic arguments
          CMD="schemachange deploy -f ./migrations -a $SNOWFLAKE_ACCOUNT -u $SNOWFLAKE_USER --create-change-history-table"
          
          # Add authentication arguments
          if [[ "$USE_KEY_PAIR" == "true" ]]; then
            # Using private key path
            CMD="$CMD --private-key-path $SNOWFLAKE_PRIVATE_KEY_PATH"
          else
            # Using password (it might need to be passed as env var SNOWFLAKE_PASSWORD purely, 
            # or usually schemachange automatically picks up SNOWFLAKE_PASSWORD env var if not passed as arg?
            # Looking at schemachange docs, strictly it uses env vars often. 
            # But let's verify if we need to be explicit or if env var is enough.
            # Usually env var SNOWFLAKE_PASSWORD is picked up by the connector.
            # We will rely on the env var we set: SNOWFLAKE_PASSWORD
            : # No-op, env var is set
          fi
          
          # Add other required params if user wants (warehouse, role, database).
          # Since user didn't specify them in prompt, we assume they might be in secrets or defaults.
          # For now, let's assume they might be passed or user relies on default user defaults.
          # However, schemachange usually requires database/warehouse/role/schema to manage the changelog.
          # We'll just run it. If it fails due to missing warehouse, user can add it.
          # Let's add basic print of what we are doing
          echo "Executing schemachange..."
          
          # run it
          $CMD
